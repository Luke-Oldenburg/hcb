<% title "Reimbursements for #{@event.name}" %>
<% page_md %>
<%= render "events/nav", selected: :reimbursements %>

<h1 class="heading flex">
  <span class="flex-grow">Reimbursements</span>
  <%= pop_icon_to "settings",
      edit_event_path(@event, tab: "reimbursements"),
      class: "tooltipped tooltipped--s", "aria-label": "Reimbursements settings" %>
  <% if @event.public_reimbursement_page_enabled? %>
    <%= pop_icon_to "external",
        reimbursement_start_reimbursement_report_url(@event),
        target: "_blank",
        class: "tooltipped tooltipped--s", "aria-label": "Public form" %>
  <% end %>
  <%= link_to "#", class: "btn bg-success", data: { behavior: "modal_trigger", modal: "create" } do %>
    <%= inline_icon "plus" %>
    New
  <% end %>
</h1>

<%= render partial: "reimbursement/reports/create_form" %>

<div class="statset mt3 mb2">
  <div class="stat">
    <span class="stat__label">Total</span>
    <span class="stat__value" style="text-wrap: nowrap">
      <%= render_money_amount(@reports.to_calculate_total.sum(&:amount_cents)) %>
    </span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Reimbursed</span>
    <span class="stat__value">
      <%= render_money_amount(@reports.reimbursed.sum(&:amount_cents)) %>
    </span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Pending</span>
    <span class="stat__value">
      <%= render_money_amount(@reports.pending.reimbursed.sum(&:amount_cents)) %>
    </span>
  </div>
</div>

<hr>

<div class="flex items-center gap-4 flex-col-reverse sm:flex-row">
  <%= form_with(model: nil, local: true, method: :get, class: "flex-1 w-full sm:w-auto") do |form| %>
    <div class="filterbar flex flex-wrap items-center width-100">
      <%= form.text_field :q, placeholder: "Searchâ€¦", class: "flex-auto md-mr2", style: "width auto; max-width: none;", value: params[:q] %>
    </div>
  <% end %>
  <div style="text-align: center;">
    <%= link_to "All", "?filter=all", class: "filterbar__item", "aria-selected": !["reimbursed", "pending", "rejected"].include?(params[:filter]), role: "tab" %>
    <%= link_to "Pending", "?filter=pending", class: "filterbar__item", "aria-selected": params[:filter] == "pending", role: "tab" %>
    <%= link_to "Reimbursed", "?filter=reimbursed", class: "filterbar__item", "aria-selected": params[:filter] == "reimbursed", role: "tab" %>
    <%= link_to "Rejected", "?filter=rejected", class: "filterbar__item", "aria-selected": params[:filter] == "rejected", role: "tab" %>
  </div>
</div>

<% if @reports.blank? %>
  <%= blankslate "No reports found!" %>
<% else %>
  <article class="table-container">
    <table>
      <thead>
      <tr>
        <th>Status</th>
        <th>Report</th>
        <th>From</th>
        <th class="right-align">Amount</th>
      </tr>
      </thead>
      <tbody>
        <% @reports.order(created_at: :desc).each do |report| %>
          <tr>
            <td>
              <% if report.status_description %>
                <span class="ml0 badge bg-<%= report.status_color %> tooltipped tooltipped--e tooltipped--xl" aria-label="<%= report.status_description %>">
                  <%= report.status_text %>
                </span>
              <% else %>
                <span class="ml0 badge bg-<%= report.status_color %>"><%= report.status_text %></span>
              <% end %>
            </td>
            <td style="max-width: 500px; overflow: hidden; text-overflow: ellipsis;">
              <%= link_to report.name, report %>
              <span class="muted">(<%= report.created_at.strftime("%m/%d/%Y") %>)</span>
            </td>
            <td>
               <%= user_mention report.user %>
            </td>
            <td class="right-align">
               <%= render_money report.amount_cents %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </article>

  <%= paginate @reports %>

  <p class="italic muted text-center">
    <%= page_entries_info @reports, entry_name: "reports" %>.
  </p>
<% end %>

<%= form_with(model: Reimbursement::Report, class: "display-none", method: :post, url: quick_expense_reimbursement_reports_path, data: { controller: "file-drop form", "file-drop-title-value": "Drop to start a report." }) do |form| %>
  <%= form.hidden_field :event_id, value: @event.id %>
  <%= form.label :file, "Choose file", class: "field--fileupload__label", data: {
        action: "
        dragover@window->file-drop#dragover
        drop@window->file-drop#drop
        dragenter@window->file-drop#dragenter
        dragleave@window->file-drop#dragleave
      "
      } %>
  <%= form.file_field :file,
      multiple: true,
      include_hidden: false,
      required: false,
      accept: "image/*,image/heic,.pdf",
      data: {
        "file-drop-target" => "fileInput",
        "action"           => "change->form#submit"
      } %>
  </div>
<% end %>
