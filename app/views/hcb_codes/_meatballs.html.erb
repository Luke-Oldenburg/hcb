<% is_pinned = hcb_code.pin.present? %>
<% pinnable = hcb_code.pinnable? %>
<% flagable = (hcb_code.stripe_card? || hcb_code.stripe_force_capture?) && hcb_code.stripe_card.present? && !hcb_code.personal_transaction.present? %>
<% disputable = can_dispute?(hcb_code:) %>

<% if disputable || flagable || pinnable %>
  <div data-controller="menu" data-menu-placement-value="bottom-end">
    <%= pop_icon_to "more",
        "#",
        class: "align-middle", "aria-label": "More Options",
        data: { turbo: true, "menu-target": "toggle", action: "menu#toggle click@document->menu#close keydown@document->menu#keydown" } %>
    <div class="menu__content menu__content--2 h5 menu__content--compact" data-menu-target="content" style="z-index: 999;">
      <% if pinnable %>
        <%= link_to pin_hcb_code_path(hcb_code), method: :post, class: "flex items-center", data: { confirm: "This will #{is_pinned ? "unpin" : "pin" } this transaction for all team members. Continue?" } do %>
          <%= inline_icon "pin-fill", size: 24 %>
          <%= is_pinned ? "Unpin from transaction list" : "Pin to top of transaction list" %>
        <% end %>
      <% end %>
      <% if flagable %>
        <%= link_to invoice_as_personal_transaction_hcb_code_path(id: hcb_code.hashid), method: :post, class: "flex items-center", data: { confirm: "Are you sure you'd like to invoice #{hcb_code.stripe_cardholder&.user&.name || "yourself"} for this transaction? They'll be emailed an invoice." } do %>
          <%= inline_icon "sad", size: 24 %>
          Flag as personal transaction
        <% end %>
      <% end %>
      <% if disputable %>
        <%= link_to dispute_hcb_code_path(hcb_code), target: "_blank" do %>
          <%= inline_icon "flag-fill", size: 24 %>
          Dispute this transaction
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>
